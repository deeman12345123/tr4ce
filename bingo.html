<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brookes Bingo</title>
    <style><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brookes Bingo</title>
    <style>
        :root {
            --primary: #C41E3A;
            --accent: #FFB81C;
            --cream: #FFF8E7;
            --dark: #3E2723;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #f5e6d3 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .hidden {
            display: none !important;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            color: var(--dark);
        }
        
        h1 { 
            font-size: 2.5rem;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            color: var(--primary);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            color: var(--dark);
        }

        .choice-screen {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 100%;
            text-align: center;
            border: 3px solid var(--primary);
        }

        .choice-screen h2 {
            color: var(--primary);
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .choice-btn {
            padding: 25px;
            font-size: 1.4rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }

        .choice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .choice-btn.join {
            background: var(--accent);
            color: var(--dark);
        }

        .setup-screen {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 100%;
            border: 3px solid var(--primary);
        }

        .setup-screen h2 {
            color: var(--primary);
            margin-bottom: 30px;
            text-align: center;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            border: 2px solid var(--accent);
            border-radius: 8px;
            background: var(--cream);
            text-transform: uppercase;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(196, 30, 58, 0.1);
        }

        .game-code-display {
            background: var(--cream);
            padding: 20px;
            border-radius: 10px;
            border: 3px solid var(--accent);
            text-align: center;
            margin-bottom: 25px;
        }

        .game-code-display .label {
            font-size: 0.9rem;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .game-code-display .code {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            letter-spacing: 3px;
        }

        .btn {
            width: 100%;
            padding: 18px;
            font-size: 1.2rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
            margin-top: 10px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #666;
            margin-top: 15px;
        }

        .lobby-screen {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            max-width: 600px;
            width: 100%;
            border: 3px solid var(--primary);
        }

        .lobby-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .lobby-header h2 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .player-list {
            background: var(--cream);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .player-list h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .player-item {
            padding: 12px;
            background: white;
            margin-bottom: 8px;
            border-radius: 6px;
            border: 2px solid var(--accent);
            font-size: 1.1rem;
            color: var(--dark);
        }

        .player-item.you {
            border-color: var(--primary);
            font-weight: bold;
        }

        .waiting-message {
            text-align: center;
            padding: 20px;
            background: #fffacd;
            border-radius: 10px;
            color: var(--dark);
            font-size: 1.1rem;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .game-screen {
            width: 100%;
            max-width: 800px;
        }

        .status-msg {
            margin-bottom: 20px;
            font-weight: bold;
            color: var(--dark);
            font-size: 1.3rem;
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: white;
            border: 2px solid var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .status-msg.win {
            background: var(--accent);
            color: var(--dark);
            border-color: var(--accent);
            animation: winPulse 0.5s ease-in-out 3;
        }

        @keyframes winPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .ticket-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .ticket {
            background: white;
            border: 3px solid var(--dark);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            max-width: 600px;
            width: 100%;
        }

        .ticket::before {
            content: '';
            display: block;
            height: 12px;
            background: repeating-linear-gradient(
                90deg,
                var(--primary) 0px,
                var(--primary) 15px,
                white 15px,
                white 30px
            );
            border-radius: 6px 6px 0 0;
            margin: -12px -12px 12px -12px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 4px;
        }

        .grid-row {
            display: contents;
        }

        .grid-row.winning .cell:not(.empty) {
            background: #90EE90;
            border-color: #228B22;
        }

        .cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            font-weight: bold;
            background: white;
            border: 2px solid #ccc;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            color: var(--dark);
        }

        .cell.empty {
            background: transparent;
            border: none;
            cursor: default;
        }

        .cell.marked::after {
            content: '';
            position: absolute;
            width: 70%;
            height: 70%;
            background: radial-gradient(circle, rgba(196, 30, 58, 0.8), rgba(196, 30, 58, 0.6));
            border-radius: 50%;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .cell { font-size: 1.2rem; }
            .choice-btn, .btn { padding: 15px; font-size: 1.1rem; }
            .ticket { padding: 10px; }
        }

        @media (max-width: 500px) {
            .cell { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <header>
        <h1>üé∞ Brookes Bingo üé∞</h1>
        <p class="subtitle">Multiplayer ‚Ä¢ Win a Bag of Lollies!</p>
    </header>

    <div class="choice-screen" id="choiceScreen">
        <h2>Welcome!</h2>
        <div class="choice-buttons">
            <button class="choice-btn" onclick="showCreateScreen()">üéÆ Create New Game</button>
            <button class="choice-btn join" onclick="showJoinScreen()">üéØ Join Existing Game</button>
        </div>
    </div>

    <div class="setup-screen hidden" id="createScreen">
        <h2>Create New Game</h2>
        <div class="game-code-display">
            <div class="label">Your Game Code:</div>
            <div class="code" id="displayGameCode">----</div>
        </div>
        <div class="input-group">
            <label for="hostName">Your Name:</label>
            <input type="text" id="hostName" placeholder="Enter your name" maxlength="20">
        </div>
        <button class="btn" onclick="createGame()">Create Game</button>
        <button class="btn btn-secondary" onclick="backToChoice()">‚Üê Back</button>
    </div>

    <div class="setup-screen hidden" id="joinScreen">
        <h2>Join Game</h2>
        <div class="input-group">
            <label for="joinCode">Game Code:</label>
            <input type="text" id="joinCode" placeholder="Enter 4-digit code" maxlength="4">
        </div>
        <div class="input-group">
            <label for="playerName">Your Name:</label>
            <input type="text" id="playerName" placeholder="Enter your name" maxlength="20">
        </div>
        <button class="btn" onclick="joinGame()">Join Game</button>
        <button class="btn btn-secondary" onclick="backToChoice()">‚Üê Back</button>
    </div>

    <div class="lobby-screen hidden" id="lobbyScreen">
        <div class="lobby-header">
            <h2>Game Lobby</h2>
            <div class="game-code-display">
                <div class="label">Game Code:</div>
                <div class="code" id="lobbyGameCode">----</div>
            </div>
        </div>

        <div class="player-list">
            <h3>Players Joined: <span id="playerCount">0</span></h3>
            <div id="playerListContainer"></div>
        </div>

        <div class="waiting-message hidden" id="waitingMessage" onclick="unlockAudio()">
            üîä TAP HERE for sound (plays music while you wait)
        </div>

        <button class="btn hidden" id="startGameBtn" onclick="startGame()">üöÄ START GAME</button>
        <button class="btn btn-secondary" onclick="leaveGame()">‚Üê Leave Game</button>
    </div>

    <div class="game-screen hidden" id="gameScreen">
        <div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap;">
            <div style="background: white; padding: 15px 25px; border-radius: 10px; border: 3px solid var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 150px;">
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Prize:</div>
                <div style="font-size: 1.3rem; font-weight: bold; color: var(--primary);">üç¨ Lollie Pack</div>
            </div>
            <div style="background: white; padding: 15px 25px; border-radius: 10px; border: 3px solid var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 120px;">
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Last Called:</div>
                <div id="lastCalledDisplay" style="font-size: 1.8rem; font-weight: bold; color: var(--primary);">--</div>
            </div>
            <div style="background: white; padding: 15px 25px; border-radius: 10px; border: 3px solid var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 120px;">
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Remaining:</div>
                <div id="remainingDisplay" style="font-size: 1.8rem; font-weight: bold; color: var(--primary);">90</div>
            </div>
        </div>
        
        <div class="status-msg" id="statusMsg" style="display: none;">Get ready...</div>
        
        <div class="ticket-wrapper">
            <div class="ticket" id="ticketContainer"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
    firebase.initializeApp({
        apiKey: "AIzaSyD5pSXhDv9jzQNIYWhNRdOVt2VR2kWYr-4",
        authDomain: "tr4ces-treatz-bingo.firebaseapp.com",
        databaseURL: "https://tr4ces-treatz-bingo-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "tr4ces-treatz-bingo",
        storageBucket: "tr4ces-treatz-bingo.firebasestorage.app",
        messagingSenderId: "755718258054",
        appId: "1:755718258054:web:5613f7a71581b1ac460007"
    });
    const database = firebase.database();

    let currentGameCode = null;
    let currentPlayerId = null;
    let playerName = '';
    let isHost = false;
    let currentTicket = null;
    let gameRef = null;
    let playersRef = null;
    let lastPlayedNumber = null;

    /* ==================== AUDIO - SINGLE ELEMENT APPROACH ==================== */
    let mainAudio = new Audio(); // ONE audio element for everything
    let lobbyMusic = new Audio();
    let audioUnlocked = false;

    function unlockAudio() {
        console.log('üîä UNLOCK: User tapped button');
        
        // Play lobby music (this is the direct user action that unlocks audio)
        lobbyMusic.src = 'bingo/startmusic.mp3';
        lobbyMusic.loop = true;
        lobbyMusic.volume = 0.7;
        
        lobbyMusic.play().then(() => {
            console.log('‚úÖ UNLOCK: Lobby music playing - audio is NOW unlocked');
            audioUnlocked = true;
            
            const msg = document.getElementById('waitingMessage');
            if (msg) {
                msg.textContent = '‚úÖ Sound enabled ‚Ä¢ Music playing ‚Ä¢ Waiting for host...';
                msg.style.background = '#90EE90';
                msg.onclick = null;
            }
        }).catch(err => {
            console.log('‚ùå UNLOCK FAILED:', err);
            alert('Audio blocked!\n\n1. Turn volume UP\n2. Take phone OFF silent\n3. Try tapping again');
        });
    }

    function playNumberSound(number) {
        console.log(`üéµ PLAY: Attempting ${number}`);
        
        if (!audioUnlocked) {
            console.log('‚ö†Ô∏è PLAY: Audio not unlocked yet!');
            return;
        }
        
        // Use the SAME audio element, just change source
        const paddedNumber = String(number).padStart(2, '0');
        mainAudio.src = `bingo/${paddedNumber}.mp3`;
        mainAudio.volume = 1.0;
        mainAudio.playbackRate = 0.9; // 90% speed - slightly faster
        
        mainAudio.play().then(() => {
            console.log(`‚úÖ PLAY: ${number} SUCCESS`);
        }).catch(err => {
            console.log(`‚ùå PLAY: ${number} FAILED:`, err);
        });
    }

    function playLossSound() {
        if (!audioUnlocked) return;
        mainAudio.src = 'bingo/bingoloss.mp3';
        mainAudio.volume = 1.0;
        mainAudio.play();
    }

    /* ==================== SCREEN NAVIGATION ==================== */
    function showScreen(screenId) {
        document.querySelectorAll('.choice-screen, .setup-screen, .lobby-screen, .game-screen').forEach(s => {
            s.classList.add('hidden');
        });
        document.getElementById(screenId).classList.remove('hidden');
    }

    function showCreateScreen() {
        currentGameCode = Math.floor(1000 + Math.random() * 9000).toString();
        document.getElementById('displayGameCode').textContent = currentGameCode;
        showScreen('createScreen');
    }

    function showJoinScreen() {
        showScreen('joinScreen');
    }

    function backToChoice() {
        showScreen('choiceScreen');
    }

    /* ==================== GAME CREATION ==================== */
    function createGame() {
        const name = document.getElementById('hostName').value.trim();
        if (!name) {
            alert('Please enter your name!');
            return;
        }

        playerName = name;
        currentPlayerId = 'player_' + Date.now();
        isHost = true;

        gameRef = database.ref('games/' + currentGameCode);
        playersRef = gameRef.child('players');

        gameRef.set({
            code: currentGameCode,
            hostId: currentPlayerId,
            status: 'lobby',
            createdAt: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            return playersRef.child(currentPlayerId).set({
                name: playerName,
                isHost: true,
                joinedAt: firebase.database.ServerValue.TIMESTAMP
            });
        }).then(() => {
            setupLobby();
        });
    }

    /* ==================== GAME JOINING ==================== */
    function joinGame() {
        const code = document.getElementById('joinCode').value.trim().toUpperCase();
        const name = document.getElementById('playerName').value.trim();

        if (!code || code.length !== 4) {
            alert('Please enter a 4-digit game code!');
            return;
        }

        if (!name) {
            alert('Please enter your name!');
            return;
        }

        currentGameCode = code;
        playerName = name;
        currentPlayerId = 'player_' + Date.now();
        isHost = false;

        gameRef = database.ref('games/' + currentGameCode);
        playersRef = gameRef.child('players');

        gameRef.once('value').then(snapshot => {
            if (!snapshot.exists()) {
                alert('Game not found! Check the code and try again.');
                return;
            }

            const gameData = snapshot.val();
            if (gameData.status !== 'lobby') {
                alert('This game has already started!');
                return;
            }

            return playersRef.child(currentPlayerId).set({
                name: playerName,
                isHost: false,
                joinedAt: firebase.database.ServerValue.TIMESTAMP
            });
        }).then(() => {
            setupLobby();
        });
    }

    /* ==================== LOBBY SETUP ==================== */
    function setupLobby() {
        document.getElementById('lobbyGameCode').textContent = currentGameCode;
        
        if (isHost) {
            document.getElementById('startGameBtn').classList.remove('hidden');
            document.getElementById('waitingMessage').classList.add('hidden');
        } else {
            document.getElementById('startGameBtn').classList.add('hidden');
            document.getElementById('waitingMessage').classList.remove('hidden');
        }

        playersRef.on('value', snapshot => {
            const players = snapshot.val() || {};
            updatePlayerList(players);
        });

        gameRef.child('status').on('value', snapshot => {
            const status = snapshot.val();
            if (status === 'playing') {
                loadGameScreen();
            }
        });

        showScreen('lobbyScreen');
    }

    function updatePlayerList(players) {
        const container = document.getElementById('playerListContainer');
        document.getElementById('playerCount').textContent = Object.keys(players).length;

        container.innerHTML = '';
        Object.entries(players).forEach(([id, player]) => {
            const div = document.createElement('div');
            div.className = 'player-item' + (id === currentPlayerId ? ' you' : '');
            div.textContent = player.name + (player.isHost ? ' üëë' : '') + (id === currentPlayerId ? ' (You)' : '');
            container.appendChild(div);
        });
    }

    function leaveGame() {
        if (currentPlayerId && playersRef) {
            playersRef.child(currentPlayerId).remove();
        }
        
        if (isHost && gameRef) {
            gameRef.remove();
        }

        currentGameCode = null;
        currentPlayerId = null;
        isHost = false;
        
        backToChoice();
    }

    /* ==================== START GAME ==================== */
    function startGame() {
        if (!isHost) return;

        // Host unlocks audio by clicking this button
        audioUnlocked = true;
        console.log('‚úÖ HOST: Audio unlocked by START GAME click');

        playersRef.once('value').then(snapshot => {
            const players = snapshot.val();
            const updates = {};

            Object.keys(players).forEach(playerId => {
                updates[`players/${playerId}/ticket`] = generateRandomTicketData();
            });

            updates['status'] = 'playing';
            updates['availableNumbers'] = Array.from({length: 90}, (_, i) => i + 1);
            updates['calledNumbers'] = [];
            updates['startedAt'] = firebase.database.ServerValue.TIMESTAMP;

            return gameRef.update(updates);
        });
    }

    /* ==================== GAME SCREEN ==================== */
    function loadGameScreen() {
        lastPlayedNumber = null;
        
        if (lobbyMusic) {
            lobbyMusic.pause();
            lobbyMusic.currentTime = 0;
            console.log('üéµ Lobby music stopped');
        }
        
        showScreen('gameScreen');
        
        playersRef.child(currentPlayerId + '/ticket').once('value').then(snapshot => {
            currentTicket = snapshot.val();
            renderTicket(currentTicket);
        });

        gameRef.child('calledNumbers').on('value', snapshot => {
            updateCalledNumbers(snapshot.val() || []);
        });

        gameRef.child('winner').on('value', snapshot => {
            const winner = snapshot.val();
            if (winner) announceWinner(winner);
        });

        if (isHost) {
            setTimeout(autoCallNumber, 2500); // 2.5 seconds before first call
        }
    }

    function autoCallNumber() {
        if (!isHost) return;

        gameRef.child('availableNumbers').once('value').then(snapshot => {
            const available = snapshot.val();
            if (!available || available.length === 0) return;

            const randomIndex = Math.floor(Math.random() * available.length);
            const number = available[randomIndex];
            available.splice(randomIndex, 1);

            gameRef.child('calledNumbers').once('value').then(calledSnapshot => {
                const called = calledSnapshot.val() || [];
                called.unshift(number);

                return gameRef.update({
                    availableNumbers: available,
                    calledNumbers: called
                });
            }).then(() => {
                lastPlayedNumber = number;
                playNumberSound(number);

                gameRef.child('winner').once('value').then(winnerSnapshot => {
                    if (!winnerSnapshot.exists()) {
                        setTimeout(autoCallNumber, 2500); // 2.5 seconds between calls
                    }
                });
            });
        });
    }

    function updateCalledNumbers(calledNumbers) {
        if (calledNumbers.length === 0) {
            document.getElementById('lastCalledDisplay').textContent = '--';
            document.getElementById('remainingDisplay').textContent = '90';
            return;
        }

        const latest = calledNumbers[0];
        const remaining = 90 - calledNumbers.length;
        
        document.getElementById('lastCalledDisplay').textContent = latest;
        document.getElementById('remainingDisplay').textContent = remaining;
        
        // CRITICAL: Play sound for joiners when new number detected
        if (latest !== lastPlayedNumber) {
            console.log(`üî• NEW NUMBER DETECTED: ${latest} - Playing for ALL players`);
            playNumberSound(latest);
            lastPlayedNumber = latest;
        }
    }

    function announceWinner(winnerData) {
        const statusEl = document.getElementById('statusMsg');
        statusEl.style.display = 'block';
        const isMe = winnerData.id === currentPlayerId;
        
        statusEl.textContent = 'Winner';
        statusEl.classList.add('win');
        
        if (!isMe) {
            playLossSound();
        }
    }

    /* ==================== TICKET ==================== */
    function generateRandomTicketData() {
        const ticket = [[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0]];
        
        for (let col = 0; col < 9; col++) {
            const min = col === 0 ? 1 : col * 10;
            const max = col === 8 ? 90 : (col + 1) * 10 - 1;
            const available = [];
            for (let n = min; n <= max; n++) available.push(n);
            
            const rows = [0, 1, 2].sort(() => Math.random() - 0.5).slice(0, Math.floor(Math.random() * 3) + 1);
            
            rows.forEach(row => {
                const idx = Math.floor(Math.random() * available.length);
                ticket[row][col] = available[idx];
                available.splice(idx, 1);
            });
        }
        
        for (let row = 0; row < 3; row++) {
            const nonZero = ticket[row].filter(n => n !== 0);
            if (nonZero.length < 5) {
                const needed = 5 - nonZero.length;
                const zeroCols = ticket[row].map((val, idx) => val === 0 ? idx : -1).filter(i => i !== -1);
                for (let i = 0; i < needed && zeroCols.length > 0; i++) {
                    const col = zeroCols[Math.floor(Math.random() * zeroCols.length)];
                    const min = col === 0 ? 1 : col * 10;
                    const max = col === 8 ? 90 : (col + 1) * 10 - 1;
                    ticket[row][col] = min + Math.floor(Math.random() * (max - min + 1));
                    zeroCols.splice(zeroCols.indexOf(col), 1);
                }
            }
        }
        
        for (let col = 0; col < 9; col++) {
            const nums = [ticket[0][col], ticket[1][col], ticket[2][col]].filter(n => n !== 0).sort((a, b) => a - b);
            let idx = 0;
            for (let row = 0; row < 3; row++) {
                if (ticket[row][col] !== 0) {
                    ticket[row][col] = nums[idx++];
                }
            }
        }
        
        return ticket;
    }

    function renderTicket(ticketData) {
        const container = document.getElementById('ticketContainer');
        container.innerHTML = '<div class="grid"></div>';
        const grid = container.querySelector('.grid');
        
        for (let row = 0; row < 3; row++) {
            for (let col = 0; col < 9; col++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                const number = ticketData[row][col];
                
                if (number === 0) {
                    cell.classList.add('empty');
                } else {
                    cell.textContent = number;
                    cell.dataset.number = number;
                    cell.onclick = () => toggleMark(cell);
                }
                
                grid.appendChild(cell);
            }
        }
    }

    function toggleMark(cell) {
        const number = parseInt(cell.dataset.number);
        
        // Check if this number has been called
        gameRef.child('calledNumbers').once('value').then(snapshot => {
            const calledNumbers = snapshot.val() || [];
            
            if (calledNumbers.includes(number)) {
                // Number has been called - allow marking/unmarking
                cell.classList.toggle('marked');
                checkWin();
            }
            // If not called, do nothing (silent blocking)
        });
    }

    function checkWin() {
        if (!currentTicket) return;

        const allCells = Array.from(document.querySelectorAll('.cell:not(.empty)'));
        const allMarked = allCells.filter(cell => cell.classList.contains('marked'));
        
        // Check if all numbers are marked (Full House)
        if (allCells.length === allMarked.length && allCells.length > 0) {
            // CRITICAL: Verify all marked numbers were actually called
            gameRef.child('calledNumbers').once('value').then(snapshot => {
                const calledNumbers = snapshot.val() || [];
                
                // Get all marked numbers
                const markedNumbers = allMarked.map(cell => parseInt(cell.dataset.number));
                
                // Check if ALL marked numbers have been called
                const allCalled = markedNumbers.every(num => calledNumbers.includes(num));
                
                if (!allCalled) {
                    console.log('‚ö†Ô∏è CHEAT DETECTED: Marked numbers that were not called!');
                    return; // Don't allow win
                }
                
                // Check if already has winner
                gameRef.child('winner').once('value').then(winnerSnapshot => {
                    if (!winnerSnapshot.exists()) {
                        // Legitimate win!
                        gameRef.update({
                            winner: {
                                id: currentPlayerId,
                                name: playerName,
                                timestamp: firebase.database.ServerValue.TIMESTAMP
                            }
                        });
                    }
                });
            });
        }
    }

    window.addEventListener('beforeunload', () => {
        if (currentPlayerId && playersRef) {
            playersRef.child(currentPlayerId).remove();
        }
    });

</script>
</body>
</html>
        :root {
            --primary: #C41E3A;
            --accent: #FFB81C;
            --cream: #FFF8E7;
            --dark: #3E2723;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #f5e6d3 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .hidden {
            display: none !important;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            color: var(--dark);
        }
        
        h1 { 
            font-size: 2.5rem;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            color: var(--primary);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            color: var(--dark);
        }

        .choice-screen {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 100%;
            text-align: center;
            border: 3px solid var(--primary);
        }

        .choice-screen h2 {
            color: var(--primary);
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .choice-btn {
            padding: 25px;
            font-size: 1.4rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }

        .choice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .choice-btn.join {
            background: var(--accent);
            color: var(--dark);
        }

        .setup-screen {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 100%;
            border: 3px solid var(--primary);
        }

        .setup-screen h2 {
            color: var(--primary);
            margin-bottom: 30px;
            text-align: center;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            border: 2px solid var(--accent);
            border-radius: 8px;
            background: var(--cream);
            text-transform: uppercase;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(196, 30, 58, 0.1);
        }

        .game-code-display {
            background: var(--cream);
            padding: 20px;
            border-radius: 10px;
            border: 3px solid var(--accent);
            text-align: center;
            margin-bottom: 25px;
        }

        .game-code-display .label {
            font-size: 0.9rem;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .game-code-display .code {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            letter-spacing: 3px;
        }

        .btn {
            width: 100%;
            padding: 18px;
            font-size: 1.2rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
            margin-top: 10px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #666;
            margin-top: 15px;
        }

        .lobby-screen {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            max-width: 600px;
            width: 100%;
            border: 3px solid var(--primary);
        }

        .lobby-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .lobby-header h2 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .player-list {
            background: var(--cream);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .player-list h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .player-item {
            padding: 12px;
            background: white;
            margin-bottom: 8px;
            border-radius: 6px;
            border: 2px solid var(--accent);
            font-size: 1.1rem;
            color: var(--dark);
        }

        .player-item.you {
            border-color: var(--primary);
            font-weight: bold;
        }

        .waiting-message {
            text-align: center;
            padding: 20px;
            background: #fffacd;
            border-radius: 10px;
            color: var(--dark);
            font-size: 1.1rem;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .game-screen {
            width: 100%;
            max-width: 800px;
        }

        .status-msg {
            margin-bottom: 20px;
            font-weight: bold;
            color: var(--dark);
            font-size: 1.3rem;
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: white;
            border: 2px solid var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .status-msg.win {
            background: var(--accent);
            color: var(--dark);
            border-color: var(--accent);
            animation: winPulse 0.5s ease-in-out 3;
        }

        @keyframes winPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .ticket-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .ticket {
            background: white;
            border: 3px solid var(--dark);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            max-width: 600px;
            width: 100%;
        }

        .ticket::before {
            content: '';
            display: block;
            height: 12px;
            background: repeating-linear-gradient(
                90deg,
                var(--primary) 0px,
                var(--primary) 15px,
                white 15px,
                white 30px
            );
            border-radius: 6px 6px 0 0;
            margin: -12px -12px 12px -12px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 4px;
        }

        .grid-row {
            display: contents;
        }

        .grid-row.winning .cell:not(.empty) {
            background: #90EE90;
            border-color: #228B22;
        }

        .cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            font-weight: bold;
            background: white;
            border: 2px solid #ccc;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            color: var(--dark);
        }

        .cell.empty {
            background: transparent;
            border: none;
            cursor: default;
        }

        .cell.marked::after {
            content: '';
            position: absolute;
            width: 70%;
            height: 70%;
            background: radial-gradient(circle, rgba(196, 30, 58, 0.8), rgba(196, 30, 58, 0.6));
            border-radius: 50%;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .cell { font-size: 1.2rem; }
            .choice-btn, .btn { padding: 15px; font-size: 1.1rem; }
            .ticket { padding: 10px; }
        }

        @media (max-width: 500px) {
            .cell { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <header>
        <h1>üé∞ Brookes Bingo üé∞</h1>
        <p class="subtitle">Multiplayer ‚Ä¢ Win a Bag of Lollies!</p>
    </header>

    <div class="choice-screen" id="choiceScreen">
        <h2>Welcome!</h2>
        <div class="choice-buttons">
            <button class="choice-btn" onclick="showCreateScreen()">üéÆ Create New Game</button>
            <button class="choice-btn join" onclick="showJoinScreen()">üéØ Join Existing Game</button>
        </div>
    </div>

    <div class="setup-screen hidden" id="createScreen">
        <h2>Create New Game</h2>
        <div class="game-code-display">
            <div class="label">Your Game Code:</div>
            <div class="code" id="displayGameCode">----</div>
        </div>
        <div class="input-group">
            <label for="hostName">Your Name:</label>
            <input type="text" id="hostName" placeholder="Enter your name" maxlength="20">
        </div>
        <button class="btn" onclick="createGame()">Create Game</button>
        <button class="btn btn-secondary" onclick="backToChoice()">‚Üê Back</button>
    </div>

    <div class="setup-screen hidden" id="joinScreen">
        <h2>Join Game</h2>
        <div class="input-group">
            <label for="joinCode">Game Code:</label>
            <input type="text" id="joinCode" placeholder="Enter 4-digit code" maxlength="4">
        </div>
        <div class="input-group">
            <label for="playerName">Your Name:</label>
            <input type="text" id="playerName" placeholder="Enter your name" maxlength="20">
        </div>
        <button class="btn" onclick="joinGame()">Join Game</button>
        <button class="btn btn-secondary" onclick="backToChoice()">‚Üê Back</button>
    </div>

    <div class="lobby-screen hidden" id="lobbyScreen">
        <div class="lobby-header">
            <h2>Game Lobby</h2>
            <div class="game-code-display">
                <div class="label">Game Code:</div>
                <div class="code" id="lobbyGameCode">----</div>
            </div>
        </div>

        <div class="player-list">
            <h3>Players Joined: <span id="playerCount">0</span></h3>
            <div id="playerListContainer"></div>
        </div>

        <div class="waiting-message hidden" id="waitingMessage" onclick="unlockAudio()">
            üîä TAP HERE for sound (plays music while you wait)
        </div>

        <button class="btn hidden" id="startGameBtn" onclick="startGame()">üöÄ START GAME</button>
        <button class="btn btn-secondary" onclick="leaveGame()">‚Üê Leave Game</button>
    </div>

    <div class="game-screen hidden" id="gameScreen">
        <div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap;">
            <div style="background: white; padding: 15px 25px; border-radius: 10px; border: 3px solid var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 150px;">
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Prize:</div>
                <div style="font-size: 1.3rem; font-weight: bold; color: var(--primary);">üç¨ Lollie Pack</div>
            </div>
            <div style="background: white; padding: 15px 25px; border-radius: 10px; border: 3px solid var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 120px;">
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Last Called:</div>
                <div id="lastCalledDisplay" style="font-size: 1.8rem; font-weight: bold; color: var(--primary);">--</div>
            </div>
            <div style="background: white; padding: 15px 25px; border-radius: 10px; border: 3px solid var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 120px;">
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Remaining:</div>
                <div id="remainingDisplay" style="font-size: 1.8rem; font-weight: bold; color: var(--primary);">90</div>
            </div>
        </div>
        
        <div class="status-msg" id="statusMsg" style="display: none;">Get ready...</div>
        
        <div class="ticket-wrapper">
            <div class="ticket" id="ticketContainer"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
    firebase.initializeApp({
        apiKey: "AIzaSyD5pSXhDv9jzQNIYWhNRdOVt2VR2kWYr-4",
        authDomain: "tr4ces-treatz-bingo.firebaseapp.com",
        databaseURL: "https://tr4ces-treatz-bingo-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "tr4ces-treatz-bingo",
        storageBucket: "tr4ces-treatz-bingo.firebasestorage.app",
        messagingSenderId: "755718258054",
        appId: "1:755718258054:web:5613f7a71581b1ac460007"
    });
    const database = firebase.database();

    let currentGameCode = null;
    let currentPlayerId = null;
    let playerName = '';
    let isHost = false;
    let currentTicket = null;
    let gameRef = null;
    let playersRef = null;
    let lastPlayedNumber = null;

    /* ==================== AUDIO - SINGLE ELEMENT APPROACH ==================== */
    let mainAudio = new Audio(); // ONE audio element for everything
    let lobbyMusic = new Audio();
    let audioUnlocked = false;

    function unlockAudio() {
        console.log('üîä UNLOCK: User tapped button');
        
        // Play lobby music (this is the direct user action that unlocks audio)
        lobbyMusic.src = 'bingo/startmusic.mp3';
        lobbyMusic.loop = true;
        lobbyMusic.volume = 0.7;
        
        lobbyMusic.play().then(() => {
            console.log('‚úÖ UNLOCK: Lobby music playing - audio is NOW unlocked');
            audioUnlocked = true;
            
            const msg = document.getElementById('waitingMessage');
            if (msg) {
                msg.textContent = '‚úÖ Sound enabled ‚Ä¢ Music playing ‚Ä¢ Waiting for host...';
                msg.style.background = '#90EE90';
                msg.onclick = null;
            }
        }).catch(err => {
            console.log('‚ùå UNLOCK FAILED:', err);
            alert('Audio blocked!\n\n1. Turn volume UP\n2. Take phone OFF silent\n3. Try tapping again');
        });
    }

    function playNumberSound(number) {
        console.log(`üéµ PLAY: Attempting ${number}`);
        
        if (!audioUnlocked) {
            console.log('‚ö†Ô∏è PLAY: Audio not unlocked yet!');
            return;
        }
        
        // Use the SAME audio element, just change source
        const paddedNumber = String(number).padStart(2, '0');
        mainAudio.src = `bingo/${paddedNumber}.mp3`;
        mainAudio.volume = 1.0;
        mainAudio.playbackRate = 0.9; // 90% speed - slightly faster
        
        mainAudio.play().then(() => {
            console.log(`‚úÖ PLAY: ${number} SUCCESS`);
        }).catch(err => {
            console.log(`‚ùå PLAY: ${number} FAILED:`, err);
        });
    }

    function playLossSound() {
        if (!audioUnlocked) return;
        mainAudio.src = 'bingo/bingoloss.mp3';
        mainAudio.volume = 1.0;
        mainAudio.play();
    }

    /* ==================== SCREEN NAVIGATION ==================== */
    function showScreen(screenId) {
        document.querySelectorAll('.choice-screen, .setup-screen, .lobby-screen, .game-screen').forEach(s => {
            s.classList.add('hidden');
        });
        document.getElementById(screenId).classList.remove('hidden');
    }

    function showCreateScreen() {
        currentGameCode = Math.floor(1000 + Math.random() * 9000).toString();
        document.getElementById('displayGameCode').textContent = currentGameCode;
        showScreen('createScreen');
    }

    function showJoinScreen() {
        showScreen('joinScreen');
    }

    function backToChoice() {
        showScreen('choiceScreen');
    }

    /* ==================== GAME CREATION ==================== */
    function createGame() {
        const name = document.getElementById('hostName').value.trim();
        if (!name) {
            alert('Please enter your name!');
            return;
        }

        playerName = name;
        currentPlayerId = 'player_' + Date.now();
        isHost = true;

        gameRef = database.ref('games/' + currentGameCode);
        playersRef = gameRef.child('players');

        gameRef.set({
            code: currentGameCode,
            hostId: currentPlayerId,
            status: 'lobby',
            createdAt: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            return playersRef.child(currentPlayerId).set({
                name: playerName,
                isHost: true,
                joinedAt: firebase.database.ServerValue.TIMESTAMP
            });
        }).then(() => {
            setupLobby();
        });
    }

    /* ==================== GAME JOINING ==================== */
    function joinGame() {
        const code = document.getElementById('joinCode').value.trim().toUpperCase();
        const name = document.getElementById('playerName').value.trim();

        if (!code || code.length !== 4) {
            alert('Please enter a 4-digit game code!');
            return;
        }

        if (!name) {
            alert('Please enter your name!');
            return;
        }

        currentGameCode = code;
        playerName = name;
        currentPlayerId = 'player_' + Date.now();
        isHost = false;

        gameRef = database.ref('games/' + currentGameCode);
        playersRef = gameRef.child('players');

        gameRef.once('value').then(snapshot => {
            if (!snapshot.exists()) {
                alert('Game not found! Check the code and try again.');
                return;
            }

            const gameData = snapshot.val();
            if (gameData.status !== 'lobby') {
                alert('This game has already started!');
                return;
            }

            return playersRef.child(currentPlayerId).set({
                name: playerName,
                isHost: false,
                joinedAt: firebase.database.ServerValue.TIMESTAMP
            });
        }).then(() => {
            setupLobby();
        });
    }

    /* ==================== LOBBY SETUP ==================== */
    function setupLobby() {
        document.getElementById('lobbyGameCode').textContent = currentGameCode;
        
        if (isHost) {
            document.getElementById('startGameBtn').classList.remove('hidden');
            document.getElementById('waitingMessage').classList.add('hidden');
        } else {
            document.getElementById('startGameBtn').classList.add('hidden');
            document.getElementById('waitingMessage').classList.remove('hidden');
        }

        playersRef.on('value', snapshot => {
            const players = snapshot.val() || {};
            updatePlayerList(players);
        });

        gameRef.child('status').on('value', snapshot => {
            const status = snapshot.val();
            if (status === 'playing') {
                loadGameScreen();
            }
        });

        showScreen('lobbyScreen');
    }

    function updatePlayerList(players) {
        const container = document.getElementById('playerListContainer');
        document.getElementById('playerCount').textContent = Object.keys(players).length;

        container.innerHTML = '';
        Object.entries(players).forEach(([id, player]) => {
            const div = document.createElement('div');
            div.className = 'player-item' + (id === currentPlayerId ? ' you' : '');
            div.textContent = player.name + (player.isHost ? ' üëë' : '') + (id === currentPlayerId ? ' (You)' : '');
            container.appendChild(div);
        });
    }

    function leaveGame() {
        if (currentPlayerId && playersRef) {
            playersRef.child(currentPlayerId).remove();
        }
        
        if (isHost && gameRef) {
            gameRef.remove();
        }

        currentGameCode = null;
        currentPlayerId = null;
        isHost = false;
        
        backToChoice();
    }

    /* ==================== START GAME ==================== */
    function startGame() {
        if (!isHost) return;

        // Host unlocks audio by clicking this button
        audioUnlocked = true;
        console.log('‚úÖ HOST: Audio unlocked by START GAME click');

        playersRef.once('value').then(snapshot => {
            const players = snapshot.val();
            const updates = {};

            Object.keys(players).forEach(playerId => {
                updates[`players/${playerId}/ticket`] = generateRandomTicketData();
            });

            updates['status'] = 'playing';
            updates['availableNumbers'] = Array.from({length: 90}, (_, i) => i + 1);
            updates['calledNumbers'] = [];
            updates['startedAt'] = firebase.database.ServerValue.TIMESTAMP;

            return gameRef.update(updates);
        });
    }

    /* ==================== GAME SCREEN ==================== */
    function loadGameScreen() {
        lastPlayedNumber = null;
        
        if (lobbyMusic) {
            lobbyMusic.pause();
            lobbyMusic.currentTime = 0;
            console.log('üéµ Lobby music stopped');
        }
        
        showScreen('gameScreen');
        
        playersRef.child(currentPlayerId + '/ticket').once('value').then(snapshot => {
            currentTicket = snapshot.val();
            renderTicket(currentTicket);
        });

        gameRef.child('calledNumbers').on('value', snapshot => {
            updateCalledNumbers(snapshot.val() || []);
        });

        gameRef.child('winner').on('value', snapshot => {
            const winner = snapshot.val();
            if (winner) announceWinner(winner);
        });

        if (isHost) {
            setTimeout(autoCallNumber, 2500); // 2.5 seconds before first call
        }
    }

    function autoCallNumber() {
        if (!isHost) return;

        gameRef.child('availableNumbers').once('value').then(snapshot => {
            const available = snapshot.val();
            if (!available || available.length === 0) return;

            const randomIndex = Math.floor(Math.random() * available.length);
            const number = available[randomIndex];
            available.splice(randomIndex, 1);

            gameRef.child('calledNumbers').once('value').then(calledSnapshot => {
                const called = calledSnapshot.val() || [];
                called.unshift(number);

                return gameRef.update({
                    availableNumbers: available,
                    calledNumbers: called
                });
            }).then(() => {
                lastPlayedNumber = number;
                playNumberSound(number);

                gameRef.child('winner').once('value').then(winnerSnapshot => {
                    if (!winnerSnapshot.exists()) {
                        setTimeout(autoCallNumber, 2500); // 2.5 seconds between calls
                    }
                });
            });
        });
    }

    function updateCalledNumbers(calledNumbers) {
        if (calledNumbers.length === 0) {
            document.getElementById('lastCalledDisplay').textContent = '--';
            document.getElementById('remainingDisplay').textContent = '90';
            return;
        }

        const latest = calledNumbers[0];
        const remaining = 90 - calledNumbers.length;
        
        document.getElementById('lastCalledDisplay').textContent = latest;
        document.getElementById('remainingDisplay').textContent = remaining;
        
        // CRITICAL: Play sound for joiners when new number detected
        if (latest !== lastPlayedNumber) {
            console.log(`üî• NEW NUMBER DETECTED: ${latest} - Playing for ALL players`);
            playNumberSound(latest);
            lastPlayedNumber = latest;
        }
    }

    function announceWinner(winnerData) {
        const statusEl = document.getElementById('statusMsg');
        statusEl.style.display = 'block';
        const isMe = winnerData.id === currentPlayerId;
        
        if (isMe) {
            statusEl.textContent = `üéâüç¨ ${winnerData.name.toUpperCase()} WINS THE LOLLIES! üç¨üéâ`;
            statusEl.classList.add('win');
        } else {
            statusEl.textContent = `üéä ${winnerData.name} wins the lollies! üéä`;
            statusEl.classList.add('win');
            playLossSound();
        }
    }

    /* ==================== TICKET ==================== */
    function generateRandomTicketData() {
        const ticket = [[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0]];
        
        for (let col = 0; col < 9; col++) {
            const min = col === 0 ? 1 : col * 10;
            const max = col === 8 ? 90 : (col + 1) * 10 - 1;
            const available = [];
            for (let n = min; n <= max; n++) available.push(n);
            
            const rows = [0, 1, 2].sort(() => Math.random() - 0.5).slice(0, Math.floor(Math.random() * 3) + 1);
            
            rows.forEach(row => {
                const idx = Math.floor(Math.random() * available.length);
                ticket[row][col] = available[idx];
                available.splice(idx, 1);
            });
        }
        
        for (let row = 0; row < 3; row++) {
            const nonZero = ticket[row].filter(n => n !== 0);
            if (nonZero.length < 5) {
                const needed = 5 - nonZero.length;
                const zeroCols = ticket[row].map((val, idx) => val === 0 ? idx : -1).filter(i => i !== -1);
                for (let i = 0; i < needed && zeroCols.length > 0; i++) {
                    const col = zeroCols[Math.floor(Math.random() * zeroCols.length)];
                    const min = col === 0 ? 1 : col * 10;
                    const max = col === 8 ? 90 : (col + 1) * 10 - 1;
                    ticket[row][col] = min + Math.floor(Math.random() * (max - min + 1));
                    zeroCols.splice(zeroCols.indexOf(col), 1);
                }
            }
        }
        
        for (let col = 0; col < 9; col++) {
            const nums = [ticket[0][col], ticket[1][col], ticket[2][col]].filter(n => n !== 0).sort((a, b) => a - b);
            let idx = 0;
            for (let row = 0; row < 3; row++) {
                if (ticket[row][col] !== 0) {
                    ticket[row][col] = nums[idx++];
                }
            }
        }
        
        return ticket;
    }

    function renderTicket(ticketData) {
        const container = document.getElementById('ticketContainer');
        container.innerHTML = '<div class="grid"></div>';
        const grid = container.querySelector('.grid');
        
        for (let row = 0; row < 3; row++) {
            for (let col = 0; col < 9; col++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                const number = ticketData[row][col];
                
                if (number === 0) {
                    cell.classList.add('empty');
                } else {
                    cell.textContent = number;
                    cell.dataset.number = number;
                    cell.onclick = () => toggleMark(cell);
                }
                
                grid.appendChild(cell);
            }
        }
    }

    function toggleMark(cell) {
        const number = parseInt(cell.dataset.number);
        
        // Check if this number has been called
        gameRef.child('calledNumbers').once('value').then(snapshot => {
            const calledNumbers = snapshot.val() || [];
            
            if (calledNumbers.includes(number)) {
                // Number has been called - allow marking/unmarking
                cell.classList.toggle('marked');
                checkWin();
            }
            // If not called, do nothing (silent blocking)
        });
    }

    function checkWin() {
        if (!currentTicket) return;

        const allCells = Array.from(document.querySelectorAll('.cell:not(.empty)'));
        const allMarked = allCells.filter(cell => cell.classList.contains('marked'));
        
        // Check if all numbers are marked (Full House)
        if (allCells.length === allMarked.length && allCells.length > 0) {
            // CRITICAL: Verify all marked numbers were actually called
            gameRef.child('calledNumbers').once('value').then(snapshot => {
                const calledNumbers = snapshot.val() || [];
                
                // Get all marked numbers
                const markedNumbers = allMarked.map(cell => parseInt(cell.dataset.number));
                
                // Check if ALL marked numbers have been called
                const allCalled = markedNumbers.every(num => calledNumbers.includes(num));
                
                if (!allCalled) {
                    console.log('‚ö†Ô∏è CHEAT DETECTED: Marked numbers that were not called!');
                    return; // Don't allow win
                }
                
                // Check if already has winner
                gameRef.child('winner').once('value').then(winnerSnapshot => {
                    if (!winnerSnapshot.exists()) {
                        // Legitimate win!
                        gameRef.update({
                            winner: {
                                id: currentPlayerId,
                                name: playerName,
                                timestamp: firebase.database.ServerValue.TIMESTAMP
                            }
                        });
                    }
                });
            });
        }
    }

    window.addEventListener('beforeunload', () => {
        if (currentPlayerId && playersRef) {
            playersRef.child(currentPlayerId).remove();
        }
    });

</script>
</body>
</html>
